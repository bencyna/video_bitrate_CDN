#!/usr/bin/env python3
import threading
from socket import *
import sys
import re

def closeConnections(clientSocket, serverSocket):
    clientSocket.close()
    serverSocket.close()
    print("Closed connections")
    
def sendMessage(message, socket):
    if isinstance(message, str):
        message = message.encode()
    socket.sendall(message)

def receiveMessageHeader(socket):
    buffer = bytearray()
    while True:
        chunk = socket.recv(1024)
        if not chunk:
            break
        buffer.extend(chunk)
        if b'\r\n\r\n' in buffer:
            break
    
    # Split at the first occurrence of \r\n\r\n
    header_end = buffer.find(b'\r\n\r\n') + 4
    headers = buffer[:header_end]
    remaining_body = buffer[header_end:]
    
    # Decode headers (headers should always be ASCII/UTF-8)
    headers_str = headers.decode('iso-8859-1')
    
    return headers_str, remaining_body

def get_content_length(headers):
    match = re.search(r'Content-Length: (\d+)', headers, re.IGNORECASE)
    if match:
        return int(match.group(1))
    return None

def receiveMessageServer(socket):
    headers_str, initial_body = receiveMessageHeader(socket)
    
    # Initialize response with headers and any initial body data
    response = headers_str.encode('iso-8859-1')
    body = initial_body
    
    # Get content length if available
    content_length = get_content_length(headers_str)
    
    if content_length is not None:
        # Keep receiving until we get the full content length
        remaining = content_length - len(initial_body)
        while remaining > 0:
            chunk = socket.recv(min(remaining, 8192))
            if not chunk:
                break
            body += chunk
            remaining -= len(chunk)
    # otherwise we have the full message
    
    # Combine headers and body
    full_response = response + body
    return full_response

def connectToServer(fake_ip, server_ip):
    serverSocket = socket(AF_INET, SOCK_STREAM)
    serverSocket.bind((fake_ip, 0))
    serverSocket.connect((server_ip, 80))
    print("Connected to server")
    return serverSocket

def runProxy(clientSocket, serverSocket):
    try:
        while True:
            # Receive message from the client
            header, _ = receiveMessageHeader(clientSocket)
            if not header:
                break
                
            # Forward message to server
            print("Sending header to server")
            sendMessage(header, serverSocket)
        
            # Receive messages from server and forward to client
            server_message = receiveMessageServer(serverSocket)
            if not server_message:
                break
                
            # Forward the complete message to the client
            sendMessage(server_message, clientSocket)
            
    except Exception as e:
        print(f"Error in proxy: {e}")
    finally:
        closeConnections(clientSocket, serverSocket)

def handle_client(clientSocket, log_file, fake_ip):
    try:
        with open(log_file, "a") as f:
            f.write("Client opened connection\n")
        
        serverSocket = connectToServer(fake_ip, server_ip)
        runProxy(clientSocket, serverSocket)
        
    except Exception as e:
        print(f"Error handling client: {e}")
        closeConnections(clientSocket, serverSocket)

if __name__ == "__main__":
    if len(sys.argv) != 5:
        print("Usage: python3", sys.argv[0], "<log>", "<listen-port>", "<fake-ip>", "<server-ip>")
        sys.exit()
        
    log_file = str(sys.argv[1])
    listen_port = int(sys.argv[2])    
    fake_ip = str(sys.argv[3])    
    server_ip = str(sys.argv[4])    
    print("log path: ", log_file, "Listen Port:", listen_port, "Fake IP:", fake_ip, "Server IP:", server_ip)

    proxySocket = socket(AF_INET, SOCK_STREAM)
    proxySocket.bind(("", listen_port))
    proxySocket.listen(5)
    
    try:
        while True:
            client_socket, client_address = proxySocket.accept()
            print(f"Client connected, starting thread")
            threading.Thread(target=handle_client, args=(client_socket, log_file, fake_ip)).start()
    except KeyboardInterrupt:
        print("\nShutting down proxy server...")
    finally:
        proxySocket.close()